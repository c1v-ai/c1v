---
phase: 03-mobile-first-web-revamp
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/manifest.ts
  - app/layout.tsx
  - public/sw.js
  - components/sw-register.tsx
  - public/icons/icon-192x192.png
  - public/icons/icon-512x512.png
  - app/offline/page.tsx
autonomous: true
subsystem: ui
agent: ui-ux-engineer

must_haves:
  truths:
    - "App can be installed to device home screen"
    - "App shows custom splash screen on launch when installed"
    - "App works in standalone mode without browser chrome"
    - "Offline page displays when network unavailable"
  artifacts:
    - path: "app/manifest.ts"
      provides: "PWA manifest with app metadata"
      exports: ["default"]
    - path: "public/sw.js"
      provides: "Service worker for caching and offline support"
      min_lines: 30
    - path: "components/sw-register.tsx"
      provides: "Client component to register service worker"
      exports: ["ServiceWorkerRegister"]
    - path: "app/offline/page.tsx"
      provides: "Offline fallback page"
      exports: ["default"]
  key_links:
    - from: "app/layout.tsx"
      to: "components/sw-register.tsx"
      via: "ServiceWorkerRegister component in body"
      pattern: "<ServiceWorkerRegister"
    - from: "public/sw.js"
      to: "app/offline/page.tsx"
      via: "fetch handler redirects to /offline"
      pattern: "'/offline'"
---

<objective>
Implement PWA foundation with manifest, service worker, and offline support.

Purpose: Make the app installable on mobile devices and provide basic offline functionality. This uses manual service worker approach (not next-pwa) because the project uses Turbopack which is incompatible with webpack-based PWA plugins.

Output:
- Type-safe manifest via app/manifest.ts (Next.js native)
- Manual service worker with caching strategies
- Offline fallback page
- PWA icons (192x192 and 512x512)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/STATE.md
@.planning/phases/03-mobile-first-web-revamp/03-RESEARCH.md

# Existing files
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA manifest and update viewport</name>
  <files>
    app/manifest.ts
    app/layout.tsx
  </files>
  <action>
1. Create `app/manifest.ts` using Next.js native manifest API:

```typescript
import type { MetadataRoute } from 'next'

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'Product Helper',
    short_name: 'PrdHelper',
    description: 'AI-Powered PRD Generation - Create engineering-quality Product Requirements Documents in minutes',
    start_url: '/',
    display: 'standalone',
    background_color: '#ffffff',
    theme_color: '#0A5C4E',
    orientation: 'portrait-primary',
    icons: [
      {
        src: '/icons/icon-192x192.png',
        sizes: '192x192',
        type: 'image/png',
        purpose: 'maskable',
      },
      {
        src: '/icons/icon-512x512.png',
        sizes: '512x512',
        type: 'image/png',
        purpose: 'any',
      },
    ],
  }
}
```

2. Update `app/layout.tsx` viewport and metadata for iOS PWA support:

```typescript
import type { Metadata, Viewport } from 'next';

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  viewportFit: 'cover', // Critical for iOS safe areas
};

export const metadata: Metadata = {
  title: 'Product Helper - AI-Powered PRD Generation',
  description: 'Create engineering-quality Product Requirements Documents in minutes through AI-powered conversational requirements gathering.',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'black-translucent',
    title: 'Product Helper',
  },
};
```

IMPORTANT: `viewportFit: 'cover'` is required for proper safe area handling on iOS when installed to home screen.
  </action>
  <verify>
    - `npm run dev` succeeds
    - Visit http://localhost:3000/manifest.webmanifest
    - JSON manifest displays with correct name, icons, theme_color
    - Check page source: viewport meta includes viewport-fit=cover
  </verify>
  <done>PWA manifest served at /manifest.webmanifest with proper iOS metadata</done>
</task>

<task type="auto">
  <name>Task 2: Create PWA icons and service worker</name>
  <files>
    public/icons/icon-192x192.png
    public/icons/icon-512x512.png
    public/sw.js
  </files>
  <action>
1. Create icons directory: `mkdir -p public/icons`

2. Create placeholder icons using ImageMagick or a simple colored square:
   - For now, create simple placeholder PNGs (can be replaced with real icons later)
   - Use the brand color #0A5C4E (teal) as background

   If ImageMagick available:
   ```bash
   convert -size 192x192 xc:'#0A5C4E' -gravity center -pointsize 48 -fill white -annotate 0 'PH' public/icons/icon-192x192.png
   convert -size 512x512 xc:'#0A5C4E' -gravity center -pointsize 128 -fill white -annotate 0 'PH' public/icons/icon-512x512.png
   ```

   Otherwise, create simple solid color PNGs programmatically or note that real icons are needed.

3. Create `public/sw.js` with caching strategies:

```javascript
const CACHE_NAME = 'product-helper-v1';
const STATIC_ASSETS = [
  '/',
  '/offline',
];

// Install: Pre-cache critical assets
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(STATIC_ASSETS);
    })
  );
  // Activate immediately without waiting for existing tabs to close
  self.skipWaiting();
});

// Activate: Clean up old caches
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((keys) => {
      return Promise.all(
        keys.filter((key) => key !== CACHE_NAME).map((key) => caches.delete(key))
      );
    })
  );
  // Take control of all clients immediately
  self.clients.claim();
});

// Fetch: Network-first for navigation, cache-first for assets
self.addEventListener('fetch', (event) => {
  const { request } = event;

  // Skip non-GET requests
  if (request.method !== 'GET') return;

  // Skip cross-origin requests
  if (!request.url.startsWith(self.location.origin)) return;

  // Network-first for HTML navigation and API calls
  if (request.mode === 'navigate' || request.url.includes('/api/')) {
    event.respondWith(
      fetch(request)
        .then((response) => {
          // Clone and cache successful responses
          if (response.ok && request.mode === 'navigate') {
            const clone = response.clone();
            caches.open(CACHE_NAME).then((cache) => cache.put(request, clone));
          }
          return response;
        })
        .catch(() => {
          // Return offline page for navigation failures
          if (request.mode === 'navigate') {
            return caches.match('/offline');
          }
          return new Response('Offline', { status: 503 });
        })
    );
    return;
  }

  // Cache-first for static assets
  event.respondWith(
    caches.match(request).then((cached) => {
      if (cached) return cached;
      return fetch(request).then((response) => {
        // Cache successful responses for static assets
        if (response.ok) {
          const clone = response.clone();
          caches.open(CACHE_NAME).then((cache) => cache.put(request, clone));
        }
        return response;
      });
    })
  );
});
```

IMPORTANT: This service worker uses:
- Network-first for navigation (always try to get fresh content)
- Cache-first for static assets (faster loads)
- Offline fallback for navigation failures
- Cache versioning for updates
  </action>
  <verify>
    - public/icons/ directory exists with two PNG files
    - public/sw.js exists with install, activate, fetch handlers
    - File sizes: icon-192x192.png > 0 bytes, icon-512x512.png > 0 bytes
  </verify>
  <done>PWA icons created and service worker ready with caching strategies</done>
</task>

<task type="auto">
  <name>Task 3: Create service worker registration and offline page</name>
  <files>
    components/sw-register.tsx
    app/offline/page.tsx
    app/layout.tsx
  </files>
  <action>
1. Create `components/sw-register.tsx`:

```typescript
'use client'

import { useEffect } from 'react'

export function ServiceWorkerRegister() {
  useEffect(() => {
    if ('serviceWorker' in navigator && process.env.NODE_ENV === 'production') {
      navigator.serviceWorker
        .register('/sw.js', { scope: '/' })
        .then((registration) => {
          console.log('SW registered:', registration.scope);
        })
        .catch((error) => {
          console.error('SW registration failed:', error);
        });
    }
  }, []);

  return null;
}
```

NOTE: Only registers in production to avoid dev server caching issues. For testing, you can temporarily remove the NODE_ENV check.

2. Create `app/offline/page.tsx`:

```typescript
import { CircleIcon, WifiOff } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default function OfflinePage() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-background">
      <div className="text-center max-w-md">
        <div className="flex items-center justify-center mb-6">
          <CircleIcon className="h-8 w-8 text-orange-500" />
          <span className="ml-2 text-2xl font-semibold">Product Helper</span>
        </div>

        <div className="mb-8">
          <WifiOff className="h-16 w-16 mx-auto mb-4 text-muted-foreground" />
          <h1 className="text-2xl font-bold mb-2">You&apos;re Offline</h1>
          <p className="text-muted-foreground">
            It looks like you&apos;ve lost your internet connection.
            Some features require a connection to work.
          </p>
        </div>

        <Button
          onClick={() => window.location.reload()}
          className="w-full"
        >
          Try Again
        </Button>

        <p className="mt-6 text-sm text-muted-foreground">
          Your work is saved locally and will sync when you&apos;re back online.
        </p>
      </div>
    </div>
  );
}
```

3. Update `app/layout.tsx` to include ServiceWorkerRegister:

```typescript
// Add import
import { ServiceWorkerRegister } from '@/components/sw-register';

// In the body, after Toaster:
<Toaster position="top-center" richColors />
<ServiceWorkerRegister />
```
  </action>
  <verify>
    - `npm run dev` succeeds
    - Visit http://localhost:3000/offline - page renders with "You're Offline" message
    - components/sw-register.tsx exists with useEffect hook
    - app/layout.tsx imports and renders ServiceWorkerRegister

    For full PWA testing (requires production build):
    - `npm run build && npm run start`
    - Open DevTools > Application > Service Workers
    - Service worker should be registered and active
    - In DevTools > Network, check "Offline"
    - Navigate to any page - should show offline page
  </verify>
  <done>
    - Service worker registration component created
    - Offline fallback page created with branded UI
    - App layout includes service worker registration
  </done>
</task>

</tasks>

<verification>
1. Manifest verification:
   - Visit /manifest.webmanifest in browser
   - All fields present: name, short_name, icons, theme_color, display

2. PWA installability (requires HTTPS or localhost):
   - Chrome DevTools > Application > Manifest
   - Should show "Installability" section with green checkmarks
   - Or warnings about what's missing

3. Offline behavior (production build only):
   - `npm run build && npm run start`
   - Register service worker by visiting site
   - DevTools > Network > Offline checkbox
   - Navigate to any route - offline page appears

4. Lighthouse audit:
   - Run Lighthouse on production build
   - PWA section should show installability passed
</verification>

<success_criteria>
- manifest.webmanifest served with correct PWA metadata
- PWA icons exist at /icons/icon-192x192.png and /icons/icon-512x512.png
- Service worker registered in production builds
- Offline page displays when network unavailable
- App installable on mobile devices (Chrome "Add to Home Screen")
- viewport-fit=cover set for iOS safe area support
</success_criteria>

<output>
After completion, create `.planning/phases/03-mobile-first-web-revamp/03-02-SUMMARY.md`
</output>

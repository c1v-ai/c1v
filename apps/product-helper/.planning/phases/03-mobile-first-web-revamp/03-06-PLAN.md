---
phase: 03-mobile-first-web-revamp
plan: 06
type: execute
wave: 3
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - package.json
  - playwright.config.ts
  - tests/e2e/responsive.spec.ts
  - tests/e2e/pwa.spec.ts
autonomous: false
subsystem: testing
agent: qa-engineer

must_haves:
  truths:
    - "Lighthouse mobile score >= 90 for performance, accessibility, best practices"
    - "PWA installability criteria met"
    - "Responsive design works on iOS Safari, Android Chrome, desktop browsers"
    - "No visual regressions on key pages"
  artifacts:
    - path: "tests/e2e/responsive.spec.ts"
      provides: "Responsive design E2E tests"
      min_lines: 50
    - path: "tests/e2e/pwa.spec.ts"
      provides: "PWA functionality tests"
      min_lines: 30
    - path: "playwright.config.ts"
      provides: "Playwright config with mobile device profiles"
      contains: "devices"
  key_links:
    - from: "playwright.config.ts"
      to: "tests/e2e/*.spec.ts"
      via: "Test discovery"
      pattern: "testDir"
---

<objective>
Set up cross-platform testing and verify Phase 3 implementation quality.

Purpose: Ensure the mobile-first revamp works correctly across devices and meets Lighthouse performance standards. This plan sets up Playwright for responsive testing and runs comprehensive verification.

Output:
- Playwright E2E test configuration with mobile device profiles
- Responsive design test suite
- PWA functionality tests
- Lighthouse performance verification
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/STATE.md
@.planning/phases/03-mobile-first-web-revamp/03-RESEARCH.md
@.planning/phases/03-mobile-first-web-revamp/03-03-SUMMARY.md
@.planning/phases/03-mobile-first-web-revamp/03-04-SUMMARY.md
@.planning/phases/03-mobile-first-web-revamp/03-05-SUMMARY.md

# Skills
@.claude/skills/testing-strategies.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Playwright with mobile device profiles</name>
  <files>
    package.json
    playwright.config.ts
  </files>
  <action>
1. Install Playwright and required dependencies:
```bash
npm install -D @playwright/test
npx playwright install
```

2. Create `playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',

  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    // Desktop browsers
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },

    // Mobile devices
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
    {
      name: 'Mobile Safari (landscape)',
      use: {
        ...devices['iPhone 12'],
        viewport: { width: 844, height: 390 },
      },
    },

    // Tablet
    {
      name: 'iPad',
      use: { ...devices['iPad (gen 7)'] },
    },
  ],

  // Start dev server for tests
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
})
```

3. Add Playwright scripts to package.json:
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:mobile": "playwright test --project='Mobile Chrome' --project='Mobile Safari'",
    "test:e2e:desktop": "playwright test --project=chromium --project=webkit",
    "test:lighthouse": "npx lighthouse http://localhost:3000 --output html --output-path ./lighthouse-report.html --view"
  }
}
```

4. Create tests directory:
```bash
mkdir -p tests/e2e
```
  </action>
  <verify>
    - playwright.config.ts exists with mobile device profiles
    - package.json has Playwright scripts
    - `npx playwright --version` shows installed version
  </verify>
  <done>Playwright configured with mobile, tablet, and desktop device profiles</done>
</task>

<task type="auto">
  <name>Task 2: Create responsive design E2E tests</name>
  <files>
    tests/e2e/responsive.spec.ts
  </files>
  <action>
Create `tests/e2e/responsive.spec.ts`:

```typescript
import { test, expect } from '@playwright/test'

test.describe('Responsive Design', () => {
  test.describe('Mobile Navigation', () => {
    test.use({ viewport: { width: 375, height: 667 } }) // iPhone SE

    test('shows bottom navigation on mobile', async ({ page }) => {
      await page.goto('/projects')

      // Bottom nav should be visible
      const bottomNav = page.locator('nav').filter({ has: page.locator('text=Home') }).last()
      await expect(bottomNav).toBeVisible()

      // Desktop nav should be hidden
      const desktopNav = page.locator('nav.hidden.md\\:flex')
      await expect(desktopNav).toBeHidden()
    })

    test('hamburger menu opens mobile drawer', async ({ page }) => {
      await page.goto('/projects')

      // Find and click hamburger menu
      const menuButton = page.getByRole('button', { name: /open menu/i })
      await expect(menuButton).toBeVisible()
      await menuButton.click()

      // Drawer should be visible with navigation items
      const drawer = page.getByRole('dialog')
      await expect(drawer).toBeVisible()
      await expect(drawer.getByText('Home')).toBeVisible()
      await expect(drawer.getByText('Projects')).toBeVisible()
    })

    test('bottom nav highlights active route', async ({ page }) => {
      await page.goto('/projects')

      // Home/Projects should be highlighted
      const projectsLink = page.locator('nav a[href="/projects"]').last()
      await expect(projectsLink).toHaveClass(/text-primary/)
    })
  })

  test.describe('Desktop Navigation', () => {
    test.use({ viewport: { width: 1280, height: 720 } })

    test('shows header navigation on desktop', async ({ page }) => {
      await page.goto('/projects')

      // Desktop nav should be visible
      const desktopNav = page.locator('nav').filter({ has: page.locator('text=Home') }).first()
      await expect(desktopNav).toBeVisible()

      // Bottom nav should be hidden
      const bottomNav = page.locator('nav.md\\:hidden')
      await expect(bottomNav).toBeHidden()
    })

    test('hamburger menu is hidden on desktop', async ({ page }) => {
      await page.goto('/projects')

      const menuButton = page.getByRole('button', { name: /open menu/i })
      await expect(menuButton).toBeHidden()
    })
  })

  test.describe('Theme Toggle', () => {
    test('theme toggle is accessible', async ({ page }) => {
      await page.goto('/projects')

      // Find theme toggle button
      const themeToggle = page.getByRole('button', { name: /toggle theme/i })
      await expect(themeToggle).toBeVisible()
    })

    test('can switch to dark mode', async ({ page }) => {
      await page.goto('/projects')

      // Click theme toggle
      const themeToggle = page.getByRole('button', { name: /toggle theme/i })
      await themeToggle.click()

      // Select dark mode
      const darkOption = page.getByRole('menuitem', { name: /dark/i })
      await darkOption.click()

      // HTML should have dark class
      const html = page.locator('html')
      await expect(html).toHaveClass(/dark/)
    })
  })

  test.describe('Touch Targets', () => {
    test.use({ viewport: { width: 375, height: 667 } })

    test('interactive elements have minimum touch target size', async ({ page }) => {
      await page.goto('/projects')

      // Check bottom nav items
      const navItems = page.locator('nav a')
      for (const item of await navItems.all()) {
        const box = await item.boundingBox()
        if (box) {
          // Minimum 44px (Apple HIG recommendation)
          expect(box.width).toBeGreaterThanOrEqual(44)
          expect(box.height).toBeGreaterThanOrEqual(44)
        }
      }
    })
  })

  test.describe('Content Layout', () => {
    test('projects grid adapts to screen size', async ({ page }) => {
      // Mobile - single column
      await page.setViewportSize({ width: 375, height: 667 })
      await page.goto('/projects')

      const gridMobile = page.locator('.grid')
      // Should have grid-cols-1 behavior (can check computed style or visual)

      // Desktop - multiple columns
      await page.setViewportSize({ width: 1280, height: 720 })
      await page.goto('/projects')
      // Should have 3+ columns
    })
  })
})
```
  </action>
  <verify>
    - File exists at tests/e2e/responsive.spec.ts
    - Tests cover mobile nav, desktop nav, theme toggle, touch targets
    - `npm run test:e2e:mobile` runs tests on mobile profiles
  </verify>
  <done>Responsive design E2E tests covering navigation, themes, and touch targets</done>
</task>

<task type="auto">
  <name>Task 3: Create PWA tests and run Lighthouse audit</name>
  <files>
    tests/e2e/pwa.spec.ts
  </files>
  <action>
1. Create `tests/e2e/pwa.spec.ts`:

```typescript
import { test, expect } from '@playwright/test'

test.describe('PWA Functionality', () => {
  test('manifest is served correctly', async ({ page }) => {
    const response = await page.goto('/manifest.webmanifest')
    expect(response?.status()).toBe(200)

    const manifest = await response?.json()
    expect(manifest.name).toBe('Product Helper')
    expect(manifest.short_name).toBe('PrdHelper')
    expect(manifest.display).toBe('standalone')
    expect(manifest.icons).toHaveLength(2)
    expect(manifest.icons[0].sizes).toBe('192x192')
    expect(manifest.icons[1].sizes).toBe('512x512')
  })

  test('icons are accessible', async ({ page }) => {
    const icon192 = await page.goto('/icons/icon-192x192.png')
    expect(icon192?.status()).toBe(200)
    expect(icon192?.headers()['content-type']).toContain('image/png')

    const icon512 = await page.goto('/icons/icon-512x512.png')
    expect(icon512?.status()).toBe(200)
    expect(icon512?.headers()['content-type']).toContain('image/png')
  })

  test('service worker is served', async ({ page }) => {
    const response = await page.goto('/sw.js')
    expect(response?.status()).toBe(200)
    expect(response?.headers()['content-type']).toContain('javascript')
  })

  test('offline page exists', async ({ page }) => {
    await page.goto('/offline')

    // Should show offline message
    await expect(page.getByText(/offline/i)).toBeVisible()
    await expect(page.getByRole('button', { name: /try again/i })).toBeVisible()
  })

  test('viewport meta is configured for PWA', async ({ page }) => {
    await page.goto('/')

    const viewport = await page.locator('meta[name="viewport"]').getAttribute('content')
    expect(viewport).toContain('viewport-fit=cover')
  })

  test('apple-mobile-web-app-capable is set', async ({ page }) => {
    await page.goto('/')

    const capable = await page.locator('meta[name="apple-mobile-web-app-capable"]').getAttribute('content')
    expect(capable).toBe('yes')
  })
})

test.describe('PWA Installability', () => {
  test('meets basic installability criteria', async ({ page }) => {
    await page.goto('/')

    // Check for manifest link
    const manifestLink = await page.locator('link[rel="manifest"]').getAttribute('href')
    expect(manifestLink).toBeTruthy()

    // Check for icons
    const appleIcon = await page.locator('link[rel="apple-touch-icon"]').count()
    // Note: apple-touch-icon is optional, but recommended
  })
})
```

2. Create a simple Lighthouse test script (optional, can be run manually):

Add to package.json scripts section:
```json
"test:lighthouse": "npx lighthouse http://localhost:3000 --output=json --output-path=./lighthouse-report.json --chrome-flags='--headless' && node scripts/check-lighthouse.js"
```

Create `scripts/check-lighthouse.js`:
```javascript
const fs = require('fs')
const report = JSON.parse(fs.readFileSync('./lighthouse-report.json', 'utf8'))

const scores = {
  performance: report.categories.performance.score * 100,
  accessibility: report.categories.accessibility.score * 100,
  'best-practices': report.categories['best-practices'].score * 100,
  seo: report.categories.seo.score * 100,
  pwa: report.categories.pwa?.score * 100 || 'N/A',
}

console.log('Lighthouse Scores:')
console.table(scores)

// Check thresholds
const failures = []
if (scores.performance < 90) failures.push(`Performance: ${scores.performance} (< 90)`)
if (scores.accessibility < 90) failures.push(`Accessibility: ${scores.accessibility} (< 90)`)
if (scores['best-practices'] < 90) failures.push(`Best Practices: ${scores['best-practices']} (< 90)`)

if (failures.length > 0) {
  console.error('\\nFailed thresholds:')
  failures.forEach(f => console.error(`  - ${f}`))
  process.exit(1)
}

console.log('\\nAll thresholds passed!')
```
  </action>
  <verify>
    - tests/e2e/pwa.spec.ts exists with manifest, icons, service worker tests
    - `npm run test:e2e` runs all tests
    - PWA tests pass (manifest served, icons exist, offline page works)
  </verify>
  <done>PWA E2E tests and Lighthouse audit configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Phase 3 mobile-first web revamp:
    1. Light/dark mode with system preference detection (03-01)
    2. PWA manifest, service worker, offline page (03-02)
    3. Mobile bottom navigation and hamburger menu (03-03)
    4. Mobile-first CSS utilities and chat optimizations (03-04)
    5. Desktop enhancements with keyboard shortcuts (03-05)
    6. E2E test suite for responsive and PWA features (03-06)
  </what-built>
  <how-to-verify>
    **Mobile Testing (use device or Chrome DevTools device mode):**
    1. Visit http://localhost:3000/projects on mobile viewport (375px)
    2. Verify bottom navigation bar is visible with 4 icons
    3. Tap hamburger menu - drawer slides in
    4. Test theme toggle - dark mode applies
    5. Navigate to a project chat - test keyboard input (no zoom on focus)

    **Desktop Testing:**
    1. Visit http://localhost:3000/projects on desktop (1280px+)
    2. Verify header navigation visible, bottom nav hidden
    3. Press Cmd/Ctrl+Shift+H - should navigate to projects
    4. Hover over project cards - should show quick actions
    5. Test theme toggle dropdown

    **PWA Testing (requires production build):**
    ```bash
    npm run build
    npm run start
    ```
    6. Visit http://localhost:3000
    7. Chrome DevTools > Application > Manifest - check validity
    8. DevTools > Application > Service Workers - check registration
    9. Check "Offline" in Network tab, navigate - offline page shows

    **Lighthouse Audit:**
    ```bash
    npm run test:lighthouse
    ```
    10. Verify mobile performance score >= 90

    **E2E Tests:**
    ```bash
    npm run test:e2e
    ```
    11. All tests pass on mobile and desktop profiles
  </how-to-verify>
  <resume-signal>
    Type "verified" if all checks pass, or describe issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. E2E test suite:
   ```bash
   npm run test:e2e
   ```
   All tests pass on mobile and desktop profiles

2. Lighthouse audit:
   ```bash
   npm run test:lighthouse
   ```
   - Performance >= 90
   - Accessibility >= 90
   - Best Practices >= 90
   - PWA criteria met

3. Manual device testing:
   - iOS Safari (actual device or BrowserStack)
   - Android Chrome
   - Desktop Chrome, Firefox, Safari
</verification>

<success_criteria>
- Playwright configured with mobile device profiles
- Responsive E2E tests pass on all profiles
- PWA tests verify manifest, icons, offline page
- Lighthouse mobile score >= 90
- No visual regressions reported in human verification
- Phase 3 features work correctly across devices
</success_criteria>

<output>
After completion, create `.planning/phases/03-mobile-first-web-revamp/03-06-SUMMARY.md`
</output>

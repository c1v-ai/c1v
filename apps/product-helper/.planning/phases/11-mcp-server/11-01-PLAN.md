---
plan: 11-01
name: MCP Server Framework
wave: 1
autonomous: true
subsystem: api
agent: backend-architect
---

# Plan 11-01: MCP Server Framework

## Objective

Create the core MCP server infrastructure with JSON-RPC protocol handling, routing, and tool registration system.

## Context

- MCP uses JSON-RPC 2.0 over HTTP
- Needs to handle tool listing (`tools/list`) and tool execution (`tools/call`)
- Must be compatible with Claude Code's MCP client
- API will be at `/api/mcp/[projectId]`

## Tasks

### Task 1: Create MCP Protocol Handler

**File:** `lib/mcp/server.ts`

```typescript
// Core MCP server implementation
// - Handle JSON-RPC 2.0 requests
// - Route to tool handlers
// - Format responses per MCP spec

export interface MCPRequest {
  jsonrpc: '2.0';
  id: string | number;
  method: string;
  params?: Record<string, unknown>;
}

export interface MCPResponse {
  jsonrpc: '2.0';
  id: string | number;
  result?: unknown;
  error?: MCPError;
}

export class MCPServer {
  async handleRequest(req: MCPRequest, projectId: string): Promise<MCPResponse>;
  async listTools(): Promise<ToolDefinition[]>;
  async callTool(name: string, args: unknown, projectId: string): Promise<unknown>;
}
```

### Task 2: Create Tool Registry

**File:** `lib/mcp/tool-registry.ts`

```typescript
// Tool registration and discovery
// - Register tool handlers
// - Validate tool inputs
// - Provide tool schemas for listing

export interface ToolDefinition {
  name: string;
  description: string;
  inputSchema: JSONSchema;
}

export interface ToolHandler {
  definition: ToolDefinition;
  execute: (args: unknown, projectId: string) => Promise<unknown>;
}

export const toolRegistry = new Map<string, ToolHandler>();
export function registerTool(handler: ToolHandler): void;
export function getTool(name: string): ToolHandler | undefined;
export function listTools(): ToolDefinition[];
```

### Task 3: Create Main MCP Route

**File:** `app/api/mcp/[projectId]/route.ts`

```typescript
// Main MCP endpoint
// - POST: Handle JSON-RPC requests
// - Validate API key from Authorization header
// - Route to MCPServer

export async function POST(
  request: Request,
  { params }: { params: { projectId: string } }
): Promise<Response>;
```

### Task 4: Create MCP Types

**File:** `lib/mcp/types.ts`

```typescript
// Shared types for MCP implementation
// - Request/Response types
// - Tool definition types
// - Error codes
```

### Task 5: Add Tests

**File:** `lib/mcp/__tests__/server.test.ts`

Test cases:
- JSON-RPC request parsing
- tools/list response format
- tools/call routing
- Error handling (invalid method, tool not found)

## Dependencies

None - can run in parallel with 11-02 and 11-03.

## Deliverables

- [ ] `lib/mcp/server.ts` - MCP protocol handler
- [ ] `lib/mcp/tool-registry.ts` - Tool registration
- [ ] `lib/mcp/types.ts` - Shared types
- [ ] `app/api/mcp/[projectId]/route.ts` - HTTP endpoint
- [ ] Tests pass

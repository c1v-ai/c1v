---
plan: 11-02
name: API Key Management
wave: 1
autonomous: true
subsystem: auth
agent: devops-engineer
---

# Plan 11-02: API Key Management

## Objective

Create API key generation, storage, and validation for MCP endpoints. Each project gets its own API keys.

## Context

- MCP endpoints need authentication
- Keys are per-project (user can have multiple projects)
- Need ability to create, list, revoke keys
- Keys stored in database, validated on each request

## Tasks

### Task 1: Add API Keys Table

**File:** `lib/db/schema.ts` (modify)

```typescript
export const projectApiKeys = pgTable('project_api_keys', {
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id').notNull().references(() => projects.id, { onDelete: 'cascade' }),
  name: text('name').notNull(), // e.g., "Claude Code", "Cursor"
  keyHash: text('key_hash').notNull(), // bcrypt hash of the key
  keyPrefix: text('key_prefix').notNull(), // First 8 chars for display (e.g., "ph_abc123...")
  lastUsedAt: timestamp('last_used_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  revokedAt: timestamp('revoked_at'),
});
```

### Task 2: Create Key Generation Utilities

**File:** `lib/mcp/auth.ts`

```typescript
// API key generation and validation

export function generateApiKey(): { key: string; hash: string; prefix: string };
export async function validateApiKey(key: string, projectId: string): Promise<boolean>;
export async function hashApiKey(key: string): Promise<string>;
```

Key format: `ph_${projectId.slice(0,8)}_${randomBytes(24).toString('base64url')}`

### Task 3: Create Key Management API Routes

**File:** `app/api/projects/[id]/keys/route.ts`

```typescript
// GET: List all keys for project (shows prefix + name + created + lastUsed)
// POST: Create new key (returns full key ONCE)
```

**File:** `app/api/projects/[id]/keys/[keyId]/route.ts`

```typescript
// DELETE: Revoke key (soft delete - set revokedAt)
```

### Task 4: Add Auth Middleware for MCP

**File:** `lib/mcp/middleware.ts`

```typescript
// Middleware to validate API key on MCP requests
// - Extract key from Authorization: Bearer header
// - Validate against database
// - Update lastUsedAt
// - Return 401 if invalid

export async function validateMCPAuth(
  request: Request,
  projectId: string
): Promise<{ valid: boolean; error?: string }>;
```

### Task 5: Add Rate Limiting

**File:** `lib/mcp/rate-limit.ts`

```typescript
// Simple rate limiting for MCP endpoints
// - 100 requests per minute per key
// - Use in-memory store (upgrade to Redis later if needed)

export async function checkRateLimit(keyPrefix: string): Promise<{ allowed: boolean; remaining: number }>;
```

### Task 6: Add Migration

**File:** `lib/db/migrations/0005_project_api_keys.sql`

### Task 7: Add Tests

**Files:**
- `lib/mcp/__tests__/auth.test.ts`
- `app/api/projects/[id]/keys/__tests__/route.test.ts`

## Dependencies

None - can run in parallel with 11-01 and 11-03.

## Deliverables

- [ ] `project_api_keys` table created
- [ ] Key generation and validation working
- [ ] API routes for key management
- [ ] Rate limiting in place
- [ ] Tests pass

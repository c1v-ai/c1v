---
phase: 06-content-section-views-ux-polish
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - app/api/projects/[id]/explorer/route.ts
  - components/project/nav-config.ts
  - components/project/explorer-sidebar.tsx
  - components/project/mobile-explorer-sheet.tsx
autonomous: true
subsystem: ui

must_haves:
  truths:
    - "Explorer tree items show a green checkmark icon when that section has generated data"
    - "Explorer tree items show an empty circle when that section has no data yet"
    - "Explorer tree items briefly pulse/highlight when content arrives (false->true transition)"
    - "Status indicators update in near-real-time as AI generates content"
  artifacts:
    - path: "app/api/projects/[id]/explorer/route.ts"
      provides: "Lightweight API endpoint returning ExplorerData hasData flags"
      exports: ["GET"]
    - path: "components/project/nav-config.ts"
      provides: "NavItem interface extended with optional status field"
      contains: "dataKey?"
    - path: "components/project/explorer-sidebar.tsx"
      provides: "Explorer sidebar with status indicators on tree items"
      contains: "StatusIndicator"
  key_links:
    - from: "components/project/explorer-sidebar.tsx"
      to: "app/api/projects/[id]/explorer/route.ts"
      via: "SWR fetch"
      pattern: "useSWR.*explorer"
    - from: "app/api/projects/[id]/explorer/route.ts"
      to: "lib/db/queries/explorer.ts"
      via: "getExplorerData() call -- already returns ExplorerData with hasData and completeness fields in correct shape, no changes needed to explorer.ts"
      pattern: "getExplorerData"
---

<objective>
Add completion status indicators to explorer tree items (UX-04) and pulse animation when new content arrives (UX-05). Each section in the tree shows a green checkmark (has data), empty circle (no data), or brief pulse animation (data just arrived). Data flows from a new lightweight API endpoint returning `hasData` boolean flags.

Purpose: Users can see at a glance which PRD sections have been generated and get visual feedback when AI produces new content. This removes the need to click into each section to check if content exists.
Output: Explorer API endpoint, extended NavItem, StatusIndicator component, pulse animation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-content-section-views-ux-polish/06-RESEARCH.md

Key existing code:
- `lib/db/queries/explorer.ts` -- `getExplorerData()` returns ExplorerData with `hasData` (12 boolean flags) and `completeness` (number). Already returns the exact shape the API route needs -- no modifications required.
- `components/project/nav-config.ts` -- `NavItem` interface with name, href, icon, exact, children
- `components/project/explorer-sidebar.tsx` -- renders tree with `NavItemComponent`, uses `useProjectChat()` for data
- `components/project/mobile-explorer-sheet.tsx` -- mobile version of sidebar
- `lib/api/with-project-auth.ts` -- HOF for API route auth

Data available from `ExplorerData.hasData`:
  hasSystemOverview, hasSchema, hasTechStack, hasApiSpec, hasInfrastructure, hasGuidelines, hasArchitecture, hasUserStories, hasDiagrams, hasProblemStatement, hasGoalsMetrics, hasNfr
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create explorer API endpoint and extend NavItem</name>
  <files>
    app/api/projects/[id]/explorer/route.ts
    components/project/nav-config.ts
  </files>
  <action>
    **Create lightweight explorer API endpoint:**
    Create `app/api/projects/[id]/explorer/route.ts` with a GET handler using `withProjectAuth`:

    ```typescript
    import { withProjectAuth } from '@/lib/api/with-project-auth';
    import { getExplorerData } from '@/lib/db/queries/explorer';
    import { NextResponse } from 'next/server';

    export const GET = withProjectAuth(async (req, { projectId }) => {
      const data = await getExplorerData(projectId);
      if (!data) {
        return NextResponse.json({ error: 'Not found' }, { status: 404 });
      }
      // Return only the lightweight hasData flags and completeness
      return NextResponse.json({
        hasData: data.hasData,
        completeness: data.completeness,
      });
    });
    ```

    This keeps the response small (~200 bytes) vs fetching full JSONB fields.

    **NOTE:** `getExplorerData()` in `lib/db/queries/explorer.ts` already returns the exact shape needed. It returns `{ hasData: { hasSystemOverview: boolean, ... }, completeness: number, ... }`. No changes to explorer.ts required.

    **Extend NavItem interface:**
    In `components/project/nav-config.ts`, add an optional `dataKey` field to `NavItem`:

    ```typescript
    export interface NavItem {
      name: string;
      href?: string;
      icon: LucideIcon;
      exact?: boolean;
      children?: NavItem[];
      dataKey?: string; // Maps to ExplorerData.hasData key (e.g., 'hasArchitecture')
    }
    ```

    Then add `dataKey` to each leaf NavItem in `getProjectNavItems()`:
    - Architecture Diagram: `dataKey: 'hasArchitecture'`
    - Tech Stack: `dataKey: 'hasTechStack'`
    - User Stories: `dataKey: 'hasUserStories'`
    - System Overview: `dataKey: 'hasSystemOverview'`
    - Database Schema: `dataKey: 'hasSchema'`
    - API Specification: `dataKey: 'hasApiSpec'`
    - Infrastructure: `dataKey: 'hasInfrastructure'`
    - Coding Guidelines: `dataKey: 'hasGuidelines'`
    - Diagrams: `dataKey: 'hasDiagrams'`

    Do NOT add dataKey to Overview, Generate, Connections, Settings (these are not content sections). Do NOT add to parent items (Product Requirements, Backend) -- their status is derived from children.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - API route file exists at correct path
    - NavItem interface has `dataKey?: string`
    - All 9 leaf content items have dataKey set
  </verify>
  <done>
    - GET /api/projects/[id]/explorer endpoint returns hasData flags
    - NavItem interface extended with dataKey field
    - Each content section item mapped to its hasData key
  </done>
</task>

<task type="auto">
  <name>Task 2: Add status indicators and pulse animation to explorer sidebar</name>
  <files>
    components/project/explorer-sidebar.tsx
    components/project/mobile-explorer-sheet.tsx
  </files>
  <action>
    **Add SWR fetch for explorer data:**
    In `explorer-sidebar.tsx`, add a SWR hook to fetch hasData flags:

    ```typescript
    import useSWR from 'swr';

    const fetcher = (url: string) => fetch(url).then(r => r.json());

    // Inside the sidebar component, get projectId from URL params or props
    const { data: explorerData } = useSWR(
      projectId ? `/api/projects/${projectId}/explorer` : null,
      fetcher,
      { refreshInterval: 5000 } // Poll every 5 seconds during active use
    );
    ```

    The projectId should be extracted from the current URL pathname using `useParams()` or parsed from the path.

    **Create StatusIndicator component:**
    Inside `explorer-sidebar.tsx` (or as a local component), create:

    ```typescript
    import { CheckCircle2, Circle } from 'lucide-react';

    function StatusIndicator({ hasData, isNew }: { hasData: boolean; isNew: boolean }) {
      if (hasData) {
        return (
          <CheckCircle2
            className={cn('h-3 w-3 ml-auto shrink-0', isNew && 'animate-pulse')}
            style={{ color: 'var(--success, #22c55e)' }}
          />
        );
      }
      return (
        <Circle
          className="h-3 w-3 ml-auto shrink-0"
          style={{ color: 'var(--text-muted)', opacity: 0.4 }}
        />
      );
    }
    ```

    **Render StatusIndicator in NavItemComponent:**
    For items that have a `dataKey`, look up the value from `explorerData.hasData[item.dataKey]` and render the StatusIndicator next to the item name (after the name text, before the chevron for parent items). Only render for leaf items (items with `dataKey`).

    **Pulse animation for new content (UX-05):**
    Track previous hasData values using a `useRef`:

    ```typescript
    const prevHasData = useRef<Record<string, boolean>>({});
    const [newlyCompleted, setNewlyCompleted] = useState<Set<string>>(new Set());

    useEffect(() => {
      if (!explorerData?.hasData) return;
      const newItems = new Set<string>();

      Object.entries(explorerData.hasData).forEach(([key, value]) => {
        if (value && !prevHasData.current[key]) {
          newItems.add(key);
        }
      });

      if (newItems.size > 0) {
        setNewlyCompleted(newItems);
        // Clear pulse after 3 seconds
        const timer = setTimeout(() => setNewlyCompleted(new Set()), 3000);
        return () => clearTimeout(timer);
      }

      prevHasData.current = { ...explorerData.hasData };
    }, [explorerData?.hasData]);
    ```

    Pass `isNew={newlyCompleted.has(item.dataKey)}` to StatusIndicator.

    **Mobile sidebar:**
    Apply the same StatusIndicator to `mobile-explorer-sheet.tsx`. If the mobile sheet re-uses NavItemComponent from explorer-sidebar, it will inherit the indicators. If it has its own rendering, add the same pattern.

    **Styling rules (MANDATORY):**
    - Use `style={{ color: 'var(--success, #22c55e)' }}` for checkmark (NOT `text-green-500`)
    - Use `style={{ color: 'var(--text-muted)' }}` for empty circle (NOT Tailwind color)
    - Use Tailwind `animate-pulse` for the pulse (this is a layout utility, not a color)
    - Icons should be `h-3 w-3` to stay proportional with tree item text
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `pnpm build` succeeds
    - Grep explorer-sidebar.tsx for `StatusIndicator` component
    - Grep explorer-sidebar.tsx for `useSWR` hook
    - Grep explorer-sidebar.tsx for `newlyCompleted` state (pulse tracking)
    - Grep mobile-explorer-sheet.tsx for `StatusIndicator` or similar
  </verify>
  <done>
    - Explorer tree items show green checkmark for sections with data
    - Explorer tree items show empty circle for sections without data
    - Newly-completed sections pulse for 3 seconds when data first arrives
    - Mobile sidebar has the same status indicators
    - SWR polls every 5 seconds for near-real-time updates
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. `pnpm build` -- production build succeeds
3. GET /api/projects/[id]/explorer returns JSON with hasData object
4. Explorer tree shows status icons next to section names
5. Status updates within 5 seconds of content generation
6. Pulse animation visible on newly-completed items
</verification>

<success_criteria>
- UX-04: All leaf items in explorer tree show completion status (checkmark or circle)
- UX-05: Items pulse/highlight when transitioning from empty to complete
- Explorer API endpoint works with project auth
- Mobile sidebar has same indicators as desktop
- No performance regressions from SWR polling
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-section-views-ux-polish/06-03-SUMMARY.md`
</output>

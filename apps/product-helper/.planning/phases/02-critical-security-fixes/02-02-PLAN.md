---
phase: 02-critical-security-fixes
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - app/api/user/route.ts
  - lib/db/drizzle.ts
autonomous: true
subsystem: security
tags: [auth, ssl, database, secrets]
agent: devops-engineer

must_haves:
  truths:
    - "GET /api/user never returns passwordHash field in response"
    - "Database connections use SSL in production environment"
    - "Database connections work without SSL in development"
    - "Connection pooling is configured with sensible defaults"
  artifacts:
    - path: "app/api/user/route.ts"
      provides: "User endpoint that filters sensitive fields"
      contains: "passwordHash"
      min_lines: 5
    - path: "lib/db/drizzle.ts"
      provides: "Database client with SSL and pooling"
      contains: "ssl"
      min_lines: 15
  key_links:
    - from: "lib/db/drizzle.ts"
      to: "lib/config/env.ts"
      via: "import for POSTGRES_URL"
      pattern: "import.*env.*from.*@/lib/config/env"
    - from: "app/api/user/route.ts"
      to: "lib/db/queries"
      via: "getUser import"
      pattern: "import.*getUser.*from.*@/lib/db/queries"
---

<objective>
Apply critical security fixes: filter passwordHash from API response and add SSL to database connections.

Purpose: Prevent password hash exposure (CRITICAL vulnerability) and encrypt database traffic in production.

Output:
- Fixed `app/api/user/route.ts` - No longer exposes passwordHash
- Updated `lib/db/drizzle.ts` - SSL enabled for production, connection pooling configured
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/phases/02-critical-security-fixes/02-RESEARCH.md
@.planning/phases/02-critical-security-fixes/02-01-SUMMARY.md
@.claude/skills/security-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter passwordHash from /api/user response</name>
  <files>app/api/user/route.ts</files>
  <action>
Update `app/api/user/route.ts` to filter out the passwordHash before returning the user object.

Current code returns the full user object including passwordHash - this is a CRITICAL security vulnerability.

Replace the current implementation with:

```typescript
import { getUser } from '@/lib/db/queries';

export async function GET() {
  const user = await getUser();

  if (!user) {
    return Response.json(null);
  }

  // SECURITY: Never expose password hash in API response
  const { passwordHash, ...safeUser } = user;
  return Response.json(safeUser);
}
```

This uses object destructuring to exclude passwordHash from the response. The `safeUser` object contains all user fields except passwordHash.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Log in as a test user
3. Fetch /api/user and verify response does NOT contain passwordHash:
   ```bash
   curl http://localhost:3000/api/user -H "Cookie: <session_cookie>" | grep -i passwordHash
   # Should return empty (no match)
   ```
4. Verify response still contains expected fields (id, email, name, etc.)
  </verify>
  <done>
- `app/api/user/route.ts` uses object destructuring to exclude passwordHash
- GET /api/user returns user data without passwordHash
- Other user fields (id, email, name) are still present in response
- Null case handled (returns null for unauthenticated requests)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SSL and connection pooling to database client</name>
  <files>lib/db/drizzle.ts</files>
  <action>
Update `lib/db/drizzle.ts` to:
1. Import the validated `env` from the new config module
2. Configure SSL for production (strict verification)
3. Add connection pooling with sensible defaults

Replace the current implementation with:

```typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';
import { env } from '@/lib/config/env';

// SSL configuration - strict verification in production, disabled for local dev
const ssl = process.env.NODE_ENV === 'production'
  ? { rejectUnauthorized: true }
  : undefined;

// Connection pooling configuration
export const client = postgres(env.POSTGRES_URL, {
  ssl,
  max: 10,              // Maximum connections in pool
  idle_timeout: 20,     // Close idle connections after 20s
  connect_timeout: 10,  // Timeout for new connections (seconds)
});

export const db = drizzle(client, { schema });
```

Key changes:
- Remove dotenv.config() (validation now happens in env.ts)
- Remove manual POSTGRES_URL check (validation now happens in env.ts)
- Add SSL with strict verification for production
- Add connection pooling to prevent connection exhaustion

NOTE: We use `process.env.NODE_ENV` directly for the SSL conditional (not from env object) because this is a runtime check that should always work regardless of whether NODE_ENV is in the Zod schema.
  </action>
  <verify>
1. TypeScript check: `npx tsc lib/db/drizzle.ts --noEmit --skipLibCheck`
2. Dev environment test: `npm run dev` and verify database queries work
3. Check connection works: Navigate to dashboard, verify projects load
4. Verify no SSL errors in development (SSL should be disabled)
  </verify>
  <done>
- `lib/db/drizzle.ts` imports `env` from `@/lib/config/env`
- SSL configured conditionally: `rejectUnauthorized: true` in production, `undefined` in development
- Connection pooling configured with max: 10, idle_timeout: 20, connect_timeout: 10
- dotenv.config() removed (no longer needed)
- Manual POSTGRES_URL check removed (handled by env validation)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Password exposure test:**
   ```bash
   npm run dev &
   # After login, verify passwordHash not in response
   curl -s http://localhost:3000/api/user -H "Cookie: <session>" | python3 -c "import sys,json; d=json.load(sys.stdin); print('FAIL: passwordHash exposed!' if d and 'passwordHash' in d else 'PASS: passwordHash not exposed')"
   ```

2. **Database connection test:**
   ```bash
   npm run dev
   # Navigate to /dashboard/projects and verify projects load
   # Check terminal for any SSL or connection errors
   ```

3. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   # Should pass with no errors
   ```

4. **Full test suite:**
   ```bash
   npm test
   # All 317 tests should still pass
   ```
</verification>

<success_criteria>
- [ ] `/api/user` response contains user data but NOT passwordHash
- [ ] `lib/db/drizzle.ts` uses validated `env.POSTGRES_URL`
- [ ] SSL enabled in production (`rejectUnauthorized: true`)
- [ ] SSL disabled in development (no SSL errors locally)
- [ ] Connection pooling configured (max: 10, idle_timeout: 20)
- [ ] All existing tests pass (317/317)
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-critical-security-fixes/02-02-SUMMARY.md`
</output>

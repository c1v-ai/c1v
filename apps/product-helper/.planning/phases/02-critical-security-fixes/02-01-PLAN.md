---
phase: 02-critical-security-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/config/env.ts
  - next.config.ts
autonomous: true
subsystem: security
tags: [secrets, env-validation, startup]
agent: devops-engineer

must_haves:
  truths:
    - "Application fails fast if AUTH_SECRET, OPENAI_API_KEY, or POSTGRES_URL are missing"
    - "Application fails fast if AUTH_SECRET is less than 32 characters"
    - "Application fails fast if OPENAI_API_KEY doesn't start with sk-"
    - "Environment validation runs at build time and server startup"
  artifacts:
    - path: "lib/config/env.ts"
      provides: "Zod schema for environment validation"
      exports: ["env", "Env"]
      min_lines: 20
    - path: "next.config.ts"
      provides: "Imports env.ts to trigger validation at startup"
      contains: "import '@/lib/config/env'"
  key_links:
    - from: "next.config.ts"
      to: "lib/config/env.ts"
      via: "import statement"
      pattern: "import.*@/lib/config/env"
---

<objective>
Create environment variable validation that fails fast on missing or invalid secrets.

Purpose: Prevent silent failures from missing AUTH_SECRET, OPENAI_API_KEY, or POSTGRES_URL. Catch misconfiguration at deploy time, not at first user request.

Output:
- `lib/config/env.ts` - Zod schema validating required environment variables
- Updated `next.config.ts` - Imports env.ts to run validation at startup
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/phases/02-critical-security-fixes/02-RESEARCH.md
@.claude/skills/security-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment validation schema</name>
  <files>lib/config/env.ts</files>
  <action>
Create `lib/config/env.ts` with Zod schema validation:

```typescript
import { z } from 'zod';

const envSchema = z.object({
  // Database - required
  POSTGRES_URL: z.string().min(1, 'POSTGRES_URL is required'),

  // Authentication - must be strong
  AUTH_SECRET: z.string()
    .min(32, 'AUTH_SECRET must be at least 32 characters for security'),

  // AI Services - must be valid format
  OPENAI_API_KEY: z.string()
    .startsWith('sk-', 'OPENAI_API_KEY must be a valid OpenAI key starting with sk-'),

  // Optional with defaults
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
});

// Parse and export - throws descriptive error if invalid
export const env = envSchema.parse(process.env);

// Type export for use elsewhere
export type Env = z.infer<typeof envSchema>;
```

Create the `lib/config/` directory if it doesn't exist.

NOTE: The schema intentionally validates only the critical variables listed in the roadmap. Other env vars (STRIPE_SECRET_KEY, RESEND_API_KEY, etc.) can be added later as optional fields when those features need them.
  </action>
  <verify>
Run TypeScript check: `npx tsc lib/config/env.ts --noEmit --skipLibCheck`
Verify file exists: `ls -la lib/config/env.ts`
  </verify>
  <done>
- `lib/config/env.ts` exists with Zod schema
- Schema validates POSTGRES_URL (required string)
- Schema validates AUTH_SECRET (min 32 chars)
- Schema validates OPENAI_API_KEY (starts with sk-)
- Exports `env` object and `Env` type
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire validation into application startup</name>
  <files>next.config.ts</files>
  <action>
Update `next.config.ts` to import the env validation module at the top of the file.

Add this import at the very top, BEFORE any other code:

```typescript
// Validate environment at build/start time
import '@/lib/config/env';
```

This ensures:
1. Validation runs during `next build`
2. Validation runs when server starts
3. Build/start fails immediately if secrets are missing or invalid

The import is a side-effect import - it doesn't need to export anything because the validation happens when the module is first evaluated.

Do NOT remove any existing configuration - just add the import at the top.
  </action>
  <verify>
1. Run `npm run build` and verify it completes (assuming valid .env)
2. Temporarily set AUTH_SECRET to a short value in .env.local, run `npm run build`, and verify it fails with clear error message about AUTH_SECRET length
3. Restore correct AUTH_SECRET value
  </verify>
  <done>
- `next.config.ts` imports `@/lib/config/env` at the top
- `npm run build` passes with valid environment variables
- Build fails with descriptive error when AUTH_SECRET is too short
- Build fails with descriptive error when OPENAI_API_KEY format is invalid
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Valid environment test:**
   ```bash
   npm run build
   # Should complete successfully
   ```

2. **Missing variable test:**
   ```bash
   # Temporarily unset a required var and verify failure
   POSTGRES_URL= npm run build 2>&1 | grep -i "POSTGRES_URL"
   # Should show "POSTGRES_URL is required"
   ```

3. **Invalid format test:**
   ```bash
   # Test with invalid OPENAI_API_KEY format
   OPENAI_API_KEY=invalid npm run build 2>&1 | grep -i "OPENAI_API_KEY"
   # Should show error about sk- prefix
   ```
</verification>

<success_criteria>
- [ ] `lib/config/env.ts` exists and exports validated `env` object
- [ ] `next.config.ts` imports env validation at startup
- [ ] Missing POSTGRES_URL causes build failure with clear message
- [ ] AUTH_SECRET < 32 chars causes build failure with clear message
- [ ] OPENAI_API_KEY not starting with sk- causes build failure with clear message
- [ ] Valid environment allows build to complete successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-critical-security-fixes/02-01-SUMMARY.md`
</output>

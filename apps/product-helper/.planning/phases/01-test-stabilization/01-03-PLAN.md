---
phase: 01-test-stabilization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/langchain/agents/intake/completion-detector.ts
autonomous: true

must_haves:
  truths:
    - "Bare 'generate' command is detected"
    - "Stop phrase 'That's enough for now' is detected"
    - "Generate phrase 'Generate the context diagram' is detected"
  artifacts:
    - path: "lib/langchain/agents/intake/completion-detector.ts"
      provides: "Fixed GENERATE_PHRASES and STOP_PHRASES regex patterns"
      contains: "context"
  key_links:
    - from: "completion-detector.test.ts"
      to: "completion-detector.ts"
      via: "test imports"
      pattern: "from.*completion-detector"
---

<objective>
Fix 3 failing tests in completion-detector.test.ts

Purpose: Restore full test coverage for conversation completion detection
Output: 3 additional passing tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/phases/01-test-stabilization/01-RESEARCH.md
@lib/langchain/graphs/__tests__/completion-detector.test.ts
@lib/langchain/agents/intake/completion-detector.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GENERATE_PHRASES for bare "generate" command</name>
  <files>lib/langchain/agents/intake/completion-detector.ts</files>
  <action>
Find the GENERATE_PHRASES array in the completion-detector.ts file.

Current issue: The regex `/generate (it|the|a)?\s*(diagram|artifact)?\.?$/i` requires a space after "generate".
The bare word "generate" alone doesn't match.

Fix: Add a new pattern specifically for bare "generate":
```typescript
/^generate\.?$/i,
```

Add this to the GENERATE_PHRASES array. Place it early in the array since it's the most specific (exact match).

The array should look something like:
```typescript
const GENERATE_PHRASES = [
  /^generate\.?$/i,  // NEW: bare "generate" command
  /show (me|it)\.?$/i,
  /generate (it|the|a)?\s*(diagram|artifact)?\.?$/i,
  // ... other patterns
];
```
  </action>
  <verify>npm test -- --testPathPattern="completion-detector.test.ts" -t "generate" 2>&1 | grep -E "(PASS|FAIL|generate)"</verify>
  <done>Bare "generate" command test passes</done>
</task>

<task type="auto">
  <name>Task 2: Fix STOP_PHRASES for "That's enough for now"</name>
  <files>lib/langchain/agents/intake/completion-detector.ts</files>
  <action>
Find the STOP_PHRASES array in the completion-detector.ts file.

Current pattern: `/^that'?s (enough|it|all)\.?$/i`
This requires the phrase to end with just "enough/it/all" plus optional period.

Problem: "That's enough for now" has trailing words "for now" that prevent the `$` anchor from matching.

Fix: Update the regex to allow optional trailing content:
```typescript
/^that'?s (enough|it|all)(\s+(for now|now))?\.?$/i
```

Or more permissively to allow any trailing words:
```typescript
/^that'?s (enough|it|all)(\s+.*)?\.?$/i
```

The first option is safer (explicit about what trailing phrases are allowed).
Choose the pattern that best matches the test expectation.
  </action>
  <verify>npm test -- --testPathPattern="completion-detector.test.ts" -t "enough" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>"That's enough for now" stop phrase test passes</done>
</task>

<task type="auto">
  <name>Task 3: Fix GENERATE_PHRASES for "Generate the context diagram"</name>
  <files>lib/langchain/agents/intake/completion-detector.ts</files>
  <action>
Find the GENERATE_PHRASES array in the completion-detector.ts file.

Current pattern: `/generate (it|the|a)?\s*(diagram|artifact)?\.?$/i`
Input: "Generate the context diagram"

Problem: The regex expects optional `(it|the|a)` then optional whitespace then optional `(diagram|artifact)`.
But "the context diagram" has "context" between "the" and "diagram" which isn't matched.

Fix: Update the regex to allow words between the article and diagram/artifact:
```typescript
/generate (it|the|a)?(\s+\w+)*\s*(diagram|artifact)?\.?$/i
```

Or be more explicit about diagram types:
```typescript
/generate (it|the|a)?\s*(context\s+)?(diagram|artifact)?\.?$/i
```

The first option is more flexible and handles variations like:
- "generate the flow diagram"
- "generate a class diagram"
- "generate the entity diagram"
  </action>
  <verify>npm test -- --testPathPattern="completion-detector.test.ts" -t "context diagram" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>"Generate the context diagram" test passes</done>
</task>

</tasks>

<verification>
Run all completion-detector tests:
```bash
npm test -- --testPathPattern="completion-detector.test.ts"
```

Expected: All completion-detector tests pass, including the 3 previously failing tests.

Specific tests to verify:
- Test for bare "generate" command - passes
- Test for "That's enough for now" - passes
- Test for "Generate the context diagram" - passes
</verification>

<success_criteria>
- All completion-detector.test.ts tests pass (0 failures)
- No regressions in other completion-detector tests
- No false positives introduced (regex not too permissive)
- npm test shows 3 fewer failures overall
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-stabilization/01-03-SUMMARY.md`
</output>

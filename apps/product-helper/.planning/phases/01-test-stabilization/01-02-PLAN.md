---
phase: 01-test-stabilization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/langchain/graphs/__tests__/priority-scorer.test.ts
  - lib/langchain/graphs/priority-scorer.ts
autonomous: true

must_haves:
  truths:
    - "Multiple unpassed gates test passes"
    - "Adjacent phase questions test passes"
  artifacts:
    - path: "lib/langchain/graphs/__tests__/priority-scorer.test.ts"
      provides: "Corrected test expectation for score threshold"
      contains: ">= 11"
    - path: "lib/langchain/graphs/priority-scorer.ts"
      provides: "Fixed phaseOrder array with context_diagram"
      contains: "context_diagram"
  key_links:
    - from: "priority-scorer.test.ts"
      to: "priority-scorer.ts"
      via: "test imports"
      pattern: "from.*priority-scorer"
---

<objective>
Fix 2 failing tests in priority-scorer.test.ts

Purpose: Restore full test coverage for question priority scoring
Output: 2 additional passing tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/phases/01-test-stabilization/01-RESEARCH.md
@lib/langchain/graphs/__tests__/priority-scorer.test.ts
@lib/langchain/graphs/priority-scorer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix "multiple unpassed gates" test expectation</name>
  <files>lib/langchain/graphs/__tests__/priority-scorer.test.ts</files>
  <action>
Find the "multiple unpassed gates" test (around line 263).

The test expects `externalScore >= 12` but receives `11`.

Root cause: The test's `currentPhase` is `context_diagram` but the question is for `external_systems`.
Since phases don't match, there's no phase alignment boost. The correct expected score is 11, not 12.

Fix: Change the expectation from `>= 12` to `>= 11`.

Look for something like:
```typescript
expect(externalScore).toBeGreaterThanOrEqual(12);
```

Change to:
```typescript
expect(externalScore).toBeGreaterThanOrEqual(11);
```
  </action>
  <verify>npm test -- --testPathPattern="priority-scorer.test.ts" -t "multiple unpassed gates" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>Multiple unpassed gates test passes with expectation >= 11</done>
</task>

<task type="auto">
  <name>Task 2: Fix phaseOrder array to include context_diagram</name>
  <files>lib/langchain/graphs/priority-scorer.ts</files>
  <action>
Find the `phaseOrder` array (around lines 94-101).

Current array:
```typescript
const phaseOrder = ['actors', 'external_systems', 'use_cases', 'scope', 'data_entities'];
```

Problem: `context_diagram` is used as currentPhase in tests but isn't in the array.
When `indexOf()` returns -1, the phase distance calculation breaks.

Fix: Add `context_diagram` to the phaseOrder array. Based on the logical flow (context diagram is typically generated early), add it at position 0 or 1:

```typescript
const phaseOrder = ['context_diagram', 'actors', 'external_systems', 'use_cases', 'scope', 'data_entities'];
```

Alternative fix (more defensive): Add a guard for -1:
```typescript
const currentPhaseIndex = phaseOrder.indexOf(state.currentPhase as string);
if (currentPhaseIndex === -1) {
  // Phase not found - don't apply phase distance penalty
  return score;
}
```

Prefer the first fix (adding to phaseOrder) as it's more explicit about the phase sequence.
  </action>
  <verify>npm test -- --testPathPattern="priority-scorer.test.ts" -t "adjacent phase" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>Adjacent phase questions test passes - context_diagram recognized in phaseOrder</done>
</task>

</tasks>

<verification>
Run all priority-scorer tests:
```bash
npm test -- --testPathPattern="priority-scorer.test.ts"
```

Expected: All priority-scorer tests pass, including the 2 previously failing tests.

Specific tests to verify:
- "multiple unpassed gates" - passes
- "adjacent phase questions" - passes
</verification>

<success_criteria>
- All priority-scorer.test.ts tests pass (0 failures)
- No regressions in other priority-scorer tests
- npm test shows 2 fewer failures overall
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-stabilization/01-02-SUMMARY.md`
</output>

---
phase: 01-test-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/diagrams/__tests__/generators.test.ts
  - lib/diagrams/generators.ts
autonomous: true

must_haves:
  truths:
    - "B&W styling test passes"
    - "All 7 CTX-* validation tests pass"
    - "Interaction labels test passes"
    - "Class diagram relationship test passes"
  artifacts:
    - path: "lib/diagrams/__tests__/generators.test.ts"
      provides: "Fixed test assertions for CTX-* and B&W regex"
      contains: "expect.arrayContaining"
    - path: "lib/diagrams/generators.ts"
      provides: "Fixed inferInteraction() and parseRelationship()"
      contains: "sourceEntity.toLowerCase()"
  key_links:
    - from: "generators.test.ts"
      to: "generators.ts"
      via: "test imports"
      pattern: "from.*generators"
---

<objective>
Fix 10 failing tests in generators.test.ts

Purpose: Restore full test coverage for diagram generation module
Output: 10 additional passing tests (262/272 -> 272/272 for this file)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-1.1.md
@.planning/phases/01-test-stabilization/01-RESEARCH.md
@lib/diagrams/__tests__/generators.test.ts
@lib/diagrams/generators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix test assertion issues (8 tests)</name>
  <files>lib/diagrams/__tests__/generators.test.ts</files>
  <action>
Fix the B&W styling test (around line 100):
- Change the regex `/fill:#[a-f0-9]{6}/i` to `/fill:#(?!ffffff|000000)[a-f0-9]{6}/i`
- This excludes white (#ffffff) and black (#000000) from the "no colors" check

Fix all 7 CTX-* validation tests (lines 177, 195, 213, 231, 249, 266, 291):
- Replace `expect(result.validation.errors).toContain(expect.stringContaining('CTX-XXX'))`
- With `expect(result.validation.errors).toEqual(expect.arrayContaining([expect.stringContaining('CTX-XXX')]))`
- Do this for CTX-002, CTX-003, CTX-004, CTX-005, CTX-006, CTX-W01, CTX-W04

The pattern change is needed because `toContain()` checks for exact element match, while `expect.stringContaining()` is an asymmetric matcher that needs `arrayContaining()` wrapper.
  </action>
  <verify>npm test -- --testPathPattern="generators.test.ts" 2>&1 | grep -E "(PASS|FAIL|B&W|CTX-)"</verify>
  <done>B&W styling test passes, all 7 CTX-* tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Fix inferInteraction() pattern order</name>
  <files>lib/diagrams/generators.ts</files>
  <action>
In the `inferInteraction()` function (around lines 355-378):

Reorder the pattern checks so more specific patterns come before general ones:
1. Move the `/payment/i` check BEFORE the `/api|gateway/i` check
2. This ensures "Payment Gateway" matches "payment" first, returning "processes payments via"

Current problem: "Payment Gateway" matches `/api|gateway/` before `/payment/` due to check order.

The specific reordering needed:
```typescript
// Move this check earlier (before gateway check)
if (/payment/i.test(nameLower)) return 'processes payments via';
// ...existing checks...
if (/api|gateway/i.test(nameLower)) return 'integrates with';
```
  </action>
  <verify>npm test -- --testPathPattern="generators.test.ts" -t "interaction labels" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>Interaction labels test passes - "Payment Gateway" returns "processes payments via"</done>
</task>

<task type="auto">
  <name>Task 3: Fix parseRelationship() source exclusion</name>
  <files>lib/diagrams/generators.ts</files>
  <action>
In the `parseRelationship()` function (around lines 1209-1237):

Fix the target entity lookup to exclude the source entity:

Current code:
```typescript
const targetEntity = allEntities.find((e) =>
  text.includes(e.name.toLowerCase())
);
```

Change to:
```typescript
const targetEntity = allEntities.find((e) =>
  e.name.toLowerCase() !== sourceEntity.toLowerCase() &&
  text.includes(e.name.toLowerCase())
);
```

This prevents "User has many Orders" from finding "User" as the target when "User" is the source.
The function signature includes `sourceEntity` parameter - use it for the exclusion.
  </action>
  <verify>npm test -- --testPathPattern="generators.test.ts" -t "class diagram" 2>&1 | grep -E "(PASS|FAIL)"</verify>
  <done>Class diagram test passes - "User has many Orders" correctly identifies "Order" as target</done>
</task>

</tasks>

<verification>
Run all generators tests:
```bash
npm test -- --testPathPattern="generators.test.ts"
```

Expected: All 10 previously failing tests now pass.

Specific tests to verify:
- "B&W styling" - passes
- "CTX-002", "CTX-003", "CTX-004", "CTX-005", "CTX-006" - pass
- "CTX-W01", "CTX-W04" - pass
- "interaction labels" - passes
- "class diagram" - passes
</verification>

<success_criteria>
- All generators.test.ts tests pass (0 failures)
- No regressions in other generators tests
- npm test shows 10 fewer failures overall
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-stabilization/01-01-SUMMARY.md`
</output>
